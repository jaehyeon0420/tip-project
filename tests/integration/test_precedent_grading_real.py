import pytest
import os
from src.graph.nodes.precedent_nodes import grade_precedents_node
from src.model.schema import Precedent

@pytest.mark.asyncio
async def test_grade_precedents_with_real_llm(real_state):
    """GPT-5.1-Chat로 판례 검증"""
    
    if not os.getenv("AZURE_OPENAI_API_KEY"):
        pytest.skip("AZURE_OPENAI_API_KEY가 설정되지 않아 테스트를 건너뜁니다.")

    # 테스트용 판례 데이터 (가짜 데이터지만 구조는 실제와 동일)
    real_state["retrieved_precedents"] = [
        Precedent(
            precedent_no="1",
            case_id="2020다12345",
            file_name="10.상표판결문요지집 22호.pdf",
            start_page="0",
            content="1. 이 사건 심결의 경위 원고는 2019. 5. 17. 특허심판원에 피고를상대로 확인대상표장이이 사건 등록서비스 표의 권리범위에 속한다는 확인을 구하는 적극적 권리범위확인심판을청구하였다. 특허심판원은 원고의 심판청구를 2019당1520호로 심리한 다음 2019. 10. 14. 확인대상 표장은이 사건 등록서비스표와 동일하나 피고의 상호를 상거래 관행에 따라 사용하는상표로 서 이 사건 등록서비스표의 효력이 제한된다는이유로 원고의 심판청구를 기각하는이 사건 둳쏄듧끛쁿 심결을하였다. [인정근거] 다툼 없는 사실, 갑 제1, 2, 3, 6호증(가지번호 있는 것은 가지번호 포함, 이하 같다) 의 각 기재, 변론 전체의 취지 2. 당사자 주장의 요지가. 원고 주장의 요지이 사건 심결은 확인대상표장이 피고가 자신의 상호를 상거래 관행에 따라 사용한것으로 보아이 사건 등록서비스표의 효력이 미치지 않는다고판단하였다. 이 사건 심결은 다음과 같 은이유로 위법하므로 취소되어야 한다. 피고의 상호는 글라스스토리안경(기흥구갈점)이므로 피고는 자신의 상호가 아닌 글라 스스토리라는 확인대상표장을사용하였다. 피고는 주식회사 글라스스토리안경(이하 글라스스토리안경이라 한다)과 가맹사업계약을 체결하고 다른 안경판매 사업자와 식별되는 가맹점사업자임을 나타내기 위한 영업표지로 확인대상표장을 사용하였으므로, 상호를 상거래 관행에 따라 사용한 것이아니다. 또한 피고가 사업자등록증 상의 상호인 글라스스토리안경(기흥신갈점) 중 (기흥신갈점)을 표시하지 않은 점, 피고의 매장 외관에 STORY'라는 영문자가 안경 도안과 함께 표시된 점, 피고의 가맹본부인 글라스스토리안경이 글라스스토리 또는 STORY'로 구성된 서비스표를 다 량 출원한 점등으로 보아, 확인대상표장은 피고가 상호를 상거래 관행에 따라 사용한것으로 볼 수 없다. 나. 피고 주장의 요지이 사건 심판청구의 부적법 확인대상표장는알수 없는 바탕에 글라스스토리라는 문자 로 구성된 것인 반면 피고의 실사용표장은 도형이 없 는 시멘트 판에 글라스 스토리 안경이라는 문자가 새겨진것으로 확인대상표장과는 문자와 바탕 도형이 상이하므로, 원고의이 사건 적극적 권리범위확인심판은 피고가 실시하지 않는 확 인대상표장에 대한것으로 확인의 이익이 없어부적법하다. 이 사건 등록서비스표와 확인대상표장의 불일치이 사건 등록서비스표와 확인대상표장이 상이하고, 이 사건 등록서비스표의 문자 부분 STORY'는 식별력이 없으므로, 확인대상표장은이 사건 등록서비스표의 권리범위에 속 하지않는다. 이 사건 등록서비스표의 효력 제한 피고는 상거래 관행에 따라 상호를 사용하는 방법으로 확인대상표장을 사용하였으므로, 이 사건 등록서비스표는 확인대상표장에 효력이 미치지않는다. 이 사건 등록서비스표의 무효 (가) 이 사건 등록서비스표 중 GLASS'는 지정서비스업과 관련하여 원재료, 품질, 용도 등을 기술적으로 표시한것으로 식별력이 없고, STORY'도 부가적 표현에 불과하여 식별력이 없으므로 무효사유가 있다. (나) 글라스스토리안경의 전 대표이사 A은 위 회사 명칭을 글라스스토리박스에서 글라 스스토리안경으로 변경하기 불과 40일 전에이 사건 등록서비스표를 출원하였으므로, 글라스 스토리안경의 상호변경을 미리 알았거나 짐작하면서도 같은 명칭의이 사건 등록서비스표를 법인이 아닌 개인 명의로출원하였다. 이 사건 등록서비스표는 신의칙에 위반된 출원으로 무효 사유가 있다(확인의 이익이 없다는 취지의 주장으로 볼 여지도 있다). 3. 이 사건 심결의 위법 여부가. 피고가 확인대상표장을 실시하는지 여부 확인대상표장과 피고 주장의 실사용표장은 모두 글라스 스토리라는 주된 문자 부분을 포 함하고 있고, 실사용표장의 안경이라는 문자 부분은 사용서비스업에서 판매하는 대상인 물품의 보통명칭에 불과하여 별도의 식별력을 가진다고 볼 수없으며, 양 표장의 배경 부분은 별다 른 특색 없는 회색 계열의 바탕에 불과하여 역시 별도의 식별력이 없다. 확인대상표장과 피고 주장의 실사용표장은 동일하다고 봄이 타당하므로, 이 사건 심판청구는 피고가 실시하는 확인 대상표장에 대한것으로 확인의 이익이 있어적법하다. 피고의이 부분 주장은 이유 없다. 나. 이 사건 등록서비스표와 확인대상표장의 일치 여부 판단 기준 상표의 유사 여부는 동종의 상품에 사용되는 두 개의 상표를 그 외관호칭관념 등을 객 관적, 전체적, 이격적으로 관찰하여 일반 수요자나 거래자가 상표에 대하여 느끼는 직관적 인 식을 기준으로 하여 그 어느 한 가지에 있어서라도 거래상 상품의 출처에 관하여 오인혼동을 초래할 우려가 있는지의 여부에 의하여 판단하여야 하며, 외관호칭관념 중 어느 하나가 유사 하다 하더라도 다른 점도 고려할 때 전체로서는명확히 출처의 혼동을 피할 수 있는 경우에는 유사상표라고 할 수 없으나, 반대로 서로 다른 부분이 있어도 그 호칭이나 관념이 유사하여 일 반 수요자가 오인혼동하기 쉬운 경우에는 유사상표라고 보아야 한다(대법원 2000. 4. 25. 선고 99후1096 판결 등 참조). 판단 (가) 외관의 대비과 같이 나무 널빤지 바탕에 영문이 사건 등록서비스표는 으로 STORY'라고 되어 있는 반면 확인대상표장는 무늬 둳쏄듧끛쁿 없는 회색 바탕에한글로 글라스 스토리로 나타나 있다. 양 표장은 배경 및 영문, 한글의 차 이로 외관이 유사하다고 볼 수 없다. (나) 호칭의 대비이 사건 등록서비스표의 경우 우리나라 영어 보급수준과 영어발음 관행에 따라 글라 스스토리로 호칭될 것이고, 확인대상표장 역시 같은음으로 호칭될 것이므로, 양 표장의 호칭은동일하다. (다) 관념의 대비 양 표장 모두 그 문자 부분으로 인하여 영어 GLASS'와 STORY'가 합쳐져 안경에 관 한 이야기, 유리에 관한 이야기 등의 관념을 가질 것이므로 관념이동일하다. (라) 대비 결과이 사건 등록서비스표와 확인대상표장의 외관은 다르나, 그 호칭과 관념이 동일하므 로, 양 표장에 유사한 서비스업에 함께 사용될 경우 일반 수요자나 거래자에게 상품의 출처에 관하여 오인혼동하게 할 염려가 있다. 다. 이 사건 등록서비스표의 효력이 미치는지 여부 판단 기준 상표법 제90조 제1항 1호에 의하면, 자기의 성명 또는 상호와 이들의 저명한 약칭을 상 거래 관행에 따라 사용하는 상표에 대하여는 상표권의 효력이 미치지아니한다. 이 때 상거래 관행에 따라 사용하는의 요건은 구 상표법(2016. 2. 29. 법률 제14033호로 개정되기 전의 것, 이하 같다) 제51조 제1항 제1호의 보통으로 사용하는 방법에서 변경되었는데, 그 의미와 관련 하여 대법원은 구 상표법 제51조 제1항 제1호와 관련하여, 상호 등을 보통으로 사용하는 방법으로 표시한다는 것은 상호 등을 독특한 글씨체나 색채, 도안화된 문자 등 특수한 태양으로 표시하는등으로 특별한 식별력을 갖도록 함이 없이 일반 수요자가 표장을 보고 상호등으로 인식할 수 있도록 표시하는 것을 의미하므로, 표장 자체가 특별한 식별력을 갖도록 표시되었는 지 뿐만 아니라 사용된 표장의 위치, 배열, 크기, 다른 문구와의 연결 관계, 도형과 결합되어 사용되었는지 여부 등 실제 사용 태양을 종합하여 거래통념에 의하여 판단하여야 한다.고 판 시한 바 있다(대법원 2016. 9. 30. 선고 2014다59712, 59729 판결 등 참조). 인정사실 A은 2006. 7. 3. 주식회사 글라스박스안경을 설립하여 B과 안경판매업을 영위하다가 2010. 9. 16. 이 사건 서비스표를 출원하고 2010. 10. 27. 위 회사 상호를 주식회사 글라스스토 리안경으로 변경하고 안경 가맹사업을시작하였다. A은 글라스스토리안경의 주식 35 인 24,500주를 가진주주이자 2018. 7. 3.까지 대표이사를 역임한 사람으로, 이 사건 등록서비스표를 글라스스토리안경의 가맹사업에 무상 사용하는 것을허락하였다. 글라스스토리안경은 2010. 12. 20.부터 가맹사업거래의 공정화에 관한 법률(이하 가맹 사업법이라 한다)에 따라 회사의 현황, 등록서비스표, 영업표지 등에 관한 사항을 알리는 정보 공개서를 제출공개하고 있다. 그런데 A과 B은 글라스스토리안경의 운영에 관하여 의견이 달라 갈등이불거지자, 주식회사 경일감정평가법인과 주식회사 에이원감정평가법인에 의뢰하여 2017. 12. 31. 기준이 사건 서비스표와 렌즈스토리 서비스표 가액을 각 2,772,000,000원, 2,884,000,000원으로 평가하는 감정평가서를 받고, A이 2018. 3. 29. 글라스스토리안경에이 사건 등록서비스표와 렌즈스토리 서비스표를 2,828,000,000원에 양도하는 계약을체결하였다. 그러나 A과 B은 위 양도계약이 상 법상 자기거래에 해당하는데, 이사회의 승인 결의가 없었다는이유로 2018. 11. 29. 위 양도계 약을합의해제하였다. 이후 A은 글라스스토리안경의이 사건 등록서비스표 무상 사용허락을철회하였다. A은 2019. 1. 15.경 원고에게이 사건 등록서비스표를 양도하고 이전등록을 마쳐주 었다. 한편 피고는 용인시 기흥구 구갈로00번길 0-0, 000호에서 안경점을 운영하고 있었는 데, 2012. 5. 27. 글라스스토리안경의 정보공개서를 제공받은 후, 2012. 6. 9. 글라스스토리안경과 글라스스토리 영업표지를 사용하는 내용의 안경 가맹계약을 체결하고 글라스스토리안경(기 흥구갈점)이라는상호로 사업자등록을하였다. 라고 표시하고, 외벽 돌출 간 피고는 간판에 판, 유리벽, 진열장 상단, 쇼핑백에 아래와 같이 GLASSSTORY'라고 표시하여 안경소매업 등을 영위하고 있다. [인정근거] 다툼 없는 사실, 갑 제1, 2, 9, 12, 13, 14호증, 을 제1, 2, 3호증의 각 기재 또는 영 상, 변론 전체의 취지 판단 위 인정사실에서 알 수 있는 다음과 같은 사정에 비추어 보면, 확인대상표장은 피고가 자신의 상호를 상거래 관행에 따라 사용한것으로 볼 수 없다. 피고가 사업자등록증 상의 상호를 글라스스토리안경(기흥구갈점)이라고 하고, 간판과 같이설치하였으며, 외벽 돌출 간판, 유리벽, 진 을 열장, 쇼핑백에 GLASSSTORY'라고 표시한 것은 글라스스토리안경과 사이에 체결한 가맹계약에 따른것이다. 가맹계약의 특성상 가맹점사업자는 그 서비스표나 영업표지를 배타적으로 사 용할 수 있고, 이는 동종업계의 다른 사업자와 서비스의 차별성을 부각하기 위한것이다. 피고가 외벽 측면 간판에 안경 모양의 구조물과 함께 하단에 STORY'라고 표시하였고, 유리벽, 진열장 상단, 쇼핑백에 GLASSSTORY'라고 표시한 것은 모두 같은 글씨체 이고 눈에 잘 띄게 위치하거나 표시되어 있다. 피고는 가맹계약 체결 시 이 사건 등록서비스표 및 영업표지 등의 내용을 안내하는 정보공개서를 제공받았고, 이 사건 등록서비스표의 권리관계를 알았거나충분히 알 수있었다. 당시 글라스스토리안경은이 사건 등록서비스표의 통상사용권자였고, 현재는 이를 사용할 권한을 가지고 있지 않다. 그럼에도 피고는 글라스스토리 또는 STORY'라는 문자를 계속 사용하면서 안경소매업 등을 영위하고 있다. 둳쏄듧끛쁿 피고가 사용할 권한이 없어진이 사건 등록서비스표에 대하여 확인대상표장을 자신의 상호를 상거래 관행에 따라 사용하는 것이라고 보아 계속 사용을 허용하는 것은이 사건 등록서비스표에 대한 침해를 용인하게 되는 결과가 된다. 라. 이 사건 등록서비스표의 무효 여부 상표법은 등록상표가 일정한 사유에 해당하는 경우에별도로 마련한 상표등록의 무효심판 절차를 거쳐 그 등록을무효로 할 수 있도록 규정하고 있으므로, 상표는 일단 등록된 이상 비 록 등록무효사유가 있다고 하더라도 이와 같은 심판에 의하여무효로 한다는 심결이 확정되지 않는 한 대세적으로무효로 되는 것은아니다(대법원 2012. 10. 18. 선고 2010다103000 전원합 의체 판결 등 참조). 설령 등록상표에 등록무효사유가 존재한다고 하더라도, 등록무효심결이 확 정되지 아니한 이상 등록상표로서의 효력은여전히 유지되고, 등록상표의 등록무효 여부에 대 한 최종적인 확정은 등록무효심판 절차에서 다투어지게 될 것이므로, 그와 별개의 절차로서 등 록상표와 확인대상표장을 대비하여 출처의 오인혼동을 초래할 만한 동일유사성이 있는지 여 부 또는 상표권의 효력 제한 사유의 유무 등을 심리하여 확인대상표장이 등록상표의 상표권의 효력이 미치는 객관적인 범위에 속하는지 여부를 확인해 주는 절차인 권리범위 확인심판이 확 인의 이익이 없다고 할 수는 없다. 이와 같은 법리는 서비스표에도 마찬가지로적용된다. 이 사건 등록서비스표에 대하여 등록무효심결이 확정되었다는 사정이 보이지 아니하므로, 피고의 위 주장은 더 나아가 살필 필요 없이 이유 없다. 마. 소결론 확인대상표장은이 사건 등록서비스표와 표장이 유사하고, 그 지정서비스업도 유사하므로, 이 사건 등록서비스표의 권리범위에속한다. 그럼에도 이와 결론을 달리한이 사건 심결은 위 법하므로 취소되어야 한다. 4. 결론 그렇다면, 이 사건 심결의 취소를 구하는 원고의 청구는 이유 있으므로, 이를 인용하기로 하 여 주문과 같이판결한다.",
            is_relevant=False
        )
    ]

    result = await grade_precedents_node(real_state)

    print(f'result : {result}')
    
    # 검증: LLM이 유효한 decision을 반환하는지
    assert result["grading_decision"] in ["approved", "rewrite", "web_search"]

    # approved일 경우 refined_precedents 존재 확인
    if result["grading_decision"] == "approved":
        assert "refined_precedents" in result
        # LLM 판단에 따라 관련성이 없다고 볼 수도 있으므로 길이는 0 이상
        assert len(result["refined_precedents"]) >= 0
        
        if len(result["refined_precedents"]) > 0:
            assert result["refined_precedents"][0].is_relevant is True
